<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organic Builder 4.1 (Cyclic Sugars)</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --accent-color: #2196F3;
            --danger-color: #ff4d4d;
            --text-main: #2c3e50;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
        }

        /* SIDEBAR */
        #sidebar {
            width: 280px;
            background: var(--panel-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            z-index: 10;
            padding: 10px;
            overflow-y: auto;
        }

        h3 { 
            margin: 15px 0 5px 0; 
            color: var(--text-main); 
            font-size: 0.95em; 
            text-transform: uppercase; 
            letter-spacing: 1px;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .drawer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .component-btn {
            padding: 8px;
            background: #fff;
            border: 1px solid #dfe6e9;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-size: 0.85em;
            transition: all 0.2s;
            color: #444;
        }

        .component-btn:hover { background: #e3f2fd; border-color: #2196F3; }
        .component-btn.active { background: var(--accent-color); color: white; border-color: #1565C0; }
        
        .btn-full { grid-column: span 2; }

        /* PRESET CONTROLS */
        .preset-container {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        #preset-select {
            flex-grow: 1;
            padding: 5px;
            border: 1px solid #dfe6e9;
            border-radius: 4px;
            font-size: 0.85em;
        }
        #btn-load-preset {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 0 10px;
        }

        /* CANVAS */
        #canvas-container {
            flex-grow: 1;
            position: relative;
            cursor: default;
            background: radial-gradient(circle, #ffffff 10%, #f0f2f5 90%);
        }

        canvas { display: block; }

        /* INFO PANEL */
        #info-panel {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 260px;
            pointer-events: none;
            border-left: 4px solid var(--accent-color);
            font-size: 0.9em;
        }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: baseline;}
        .label { font-weight: bold; color: #7f8c8d; font-size: 0.85em; }
        .value { color: #2c3e50; font-weight: 600; text-align: right;}
        .english { display: block; text-align: right; color: #95a5a6; font-style: italic; font-size: 0.8em; margin-top: -2px;}

        /* TOP CONTROLS */
        #controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-btn:hover { background: #f8f9fa; }
        .action-btn.active { background: #ffe0b2; border-color: #ff9800; }

        #message-box {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>üìö –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ (–ü—Ä–µ—Å–µ—Ç)</h3>
        <div class="preset-container">
            <select id="preset-select">
                <optgroup label="–í—É–≥–ª–µ–≤–æ–¥–Ω—ñ">
                    <option value="methane">–ú–µ—Ç–∞–Ω (C1)</option>
                    <option value="propane">–ü—Ä–æ–ø–∞–Ω (C3)</option>
                    <option value="benzene">–ë–µ–Ω–∑–æ–ª (C6H6)</option>
                    <option value="toluene">–¢–æ–ª—É–µ–Ω (C7H8)</option>
                </optgroup>
                <optgroup label="–°–ø–∏—Ä—Ç–∏ —Ç–∞ –§–µ–Ω–æ–ª–∏">
                    <option value="ethanol">–ï—Ç–∞–Ω–æ–ª</option>
                    <option value="glycerol">–ì–ª—ñ—Ü–µ—Ä–æ–ª (C3H8O3)</option>
                    <option value="phenol">–§–µ–Ω–æ–ª</option>
                </optgroup>
                <optgroup label="–ö–∏—Å–ª–æ—Ç–∏ —Ç–∞ –ê–º—ñ–Ω–∏">
                    <option value="acetic_acid">–û—Ü—Ç–æ–≤–∞ –∫-—Ç–∞</option>
                    <option value="pyruvic_acid">–ü—ñ—Ä–æ–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω–∞ –∫-—Ç–∞</option>
                    <option value="alanine">–ê–ª–∞–Ω—ñ–Ω (–ê–º—ñ–Ω–æ–∫–∏—Å–ª–æ—Ç–∞)</option>
                </optgroup>
                <optgroup label="–í—É–≥–ª–µ–≤–æ–¥–∏ (–¶–∏–∫–ª—ñ—á–Ω—ñ)">
                    <option value="glucose">–ì–ª—é–∫–æ–ø—ñ—Ä–∞–Ω–æ–∑–∞ (–ì–ª—é–∫–æ–∑–∞)</option>
                    <option value="fructose">–§—Ä—É–∫—Ç–æ—Ñ—É—Ä–∞–Ω–æ–∑–∞ (–§—Ä—É–∫—Ç–æ–∑–∞)</option>
                    <option value="ribose">–†–∏–±–æ—Ñ—É—Ä–∞–Ω–æ–∑–∞ (–†–∏–±–æ–∑–∞)</option>
                </optgroup>
            </select>
            <button id="btn-load-preset" onclick="app.loadPreset()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
        </div>

        <h3>üèóÔ∏è –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>
        <div class="drawer-grid">
            <button class="component-btn" onclick="app.spawnMolecule('methane')">–ú–µ—Ç–∞–Ω CH‚ÇÑ</button>
            <button class="component-btn" onclick="app.spawnMolecule('ethane')">–ï—Ç–∞–Ω C‚ÇÇH‚ÇÜ</button>
            <button class="component-btn" onclick="app.spawnMolecule('propane')">–ü—Ä–æ–ø–∞–Ω C‚ÇÉH‚Çà</button>
            <button class="component-btn" onclick="app.spawnMolecule('benzene')">–ë–µ–Ω–∑–æ–ª C‚ÇÜH‚ÇÜ</button>
        </div>

        <h3>üß© –§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ –≥—Ä—É–ø–∏</h3>
        <p style="font-size:0.75em; color:#7f8c8d; margin-top:0;">–ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ —á–µ—Ä–≤–æ–Ω–∏–π –∑–≤'—è–∑–æ–∫, —â–æ–± –¥–æ–¥–∞—Ç–∏. –ö–ª—ñ–∫–Ω—ñ—Ç—å –Ω–∞ –ø–æ—Ä–æ–∂–Ω—î –º—ñ—Å—Ü–µ, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç.</p>
        
        <div class="drawer-grid">
            <button class="component-btn group-selector" data-group="OH" onclick="app.selectGroup('OH', this)">-OH<br><small>–ì—ñ–¥—Ä–æ–∫—Å–∏–ª</small></button>
            <button class="component-btn group-selector" data-group="NH2" onclick="app.selectGroup('NH2', this)">-NH‚ÇÇ<br><small>–ê–º—ñ–Ω–æ</small></button>
            <button class="component-btn group-selector" data-group="COOH" onclick="app.selectGroup('COOH', this)">-COOH<br><small>–ö–∞—Ä–±–æ–∫—Å–∏–ª</small></button>
            <button class="component-btn group-selector" data-group="CHO" onclick="app.selectGroup('CHO', this)">-CHO<br><small>–ê–ª—å–¥–µ–≥—ñ–¥</small></button>
            <button class="component-btn group-selector" data-group="CO" onclick="app.selectGroup('CO', this)">>C=O<br><small>–ö–µ—Ç–æ</small></button>
            <button class="component-btn group-selector" data-group="O_ether" onclick="app.selectGroup('O_ether', this)">-O-<br><small>–ï—Ç–µ—Ä</small></button>
            <button class="component-btn group-selector" data-group="Cl" onclick="app.selectGroup('Cl', this)">-Cl<br><small>–•–ª–æ—Ä</small></button>
            <button class="component-btn group-selector" data-group="CH3" onclick="app.selectGroup('CH3', this)">-CH‚ÇÉ<br><small>–ú–µ—Ç–∏–ª</small></button>
        </div>

        <h3>üîó –ó–≤'—è–∑–∫–∏</h3>
        <div class="drawer-grid">
            <button id="btn-connect" class="component-btn btn-full" onclick="app.toggleConnectMode()">üîó –ó'—î–¥–Ω–∞—Ç–∏ / –ö—Ä–∞—Ç–Ω–∏–π<br><small>–ö–ª—ñ–∫–Ω—ñ—Ç—å 2 —Ä–∞–¥—ñ–∫–∞–ª–∏</small></button>
        </div>
    </div>

    <div id="canvas-container">
        <div id="message-box">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>
        <canvas id="chemCanvas"></canvas>
    </div>

    <div id="controls">
        <button class="action-btn" onclick="app.resetView()">–¶–µ–Ω—Ç—Ä</button>
        <button class="action-btn" onclick="app.clear()">–û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
    </div>

    <div id="info-panel">
        <div class="info-row">
            <span class="label">–§–æ—Ä–º—É–ª–∞:</span>
            <span class="value" id="info-formula">-</span>
        </div>
        <div class="info-row">
            <span class="label">–ö–ª–∞—Å:</span>
            <span class="value" id="info-class">-</span>
        </div>
        <div style="margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px;">
            <div class="value" id="info-name" style="font-size: 1.1em; color: var(--accent-color);"></div>
            <span class="english" id="info-name-en"></span>
        </div>
    </div>

<script>
/**
 * –°–ò–°–¢–ï–ú–ê –ö–û–ù–°–¢–ê–ù–¢ 
 */
const ATOM_SPECS = {
    C: { color: '#333333', radius: 20, valence: 4, symbol: 'C', fontColor: '#fff' },
    H: { color: '#E0E0E0', radius: 12, valence: 1, symbol: 'H', fontColor: '#555' },
    O: { color: '#F44336', radius: 18, valence: 2, symbol: 'O', fontColor: '#fff' },
    N: { color: '#2196F3', radius: 18, valence: 3, symbol: 'N', fontColor: '#fff' },
    Cl: { color: '#4CAF50', radius: 19, valence: 1, symbol: 'Cl', fontColor: '#fff' }
};

const BOND_LEN = 70;
const BOND_WIDTH = 5;

/**
 * –ë–ê–ó–ê –ó–ù–ê–ù–¨
 */
const KNOWLEDGE_BASE = {
    // --- –ê–õ–ö–ê–ù–ò ---
    "C1": { ua: "–ú–µ—Ç–∞–Ω", en: "Methane", class: "–ê–ª–∫–∞–Ω–∏" },
    "C2": { ua: "–ï—Ç–∞–Ω", en: "Ethane", class: "–ê–ª–∫–∞–Ω–∏" },
    "C3": { ua: "–ü—Ä–æ–ø–∞–Ω", en: "Propane", class: "–ê–ª–∫–∞–Ω–∏" },
    "C4_linear": { ua: "–Ω-–ë—É—Ç–∞–Ω", en: "n-Butane", class: "–ê–ª–∫–∞–Ω–∏" },
    "C4_branched": { ua: "–Ü–∑–æ–±—É—Ç–∞–Ω", en: "Isobutane", class: "–ê–ª–∫–∞–Ω–∏" },
    "C5_linear": { ua: "–Ω-–ü–µ–Ω—Ç–∞–Ω", en: "n-Pentane", class: "–ê–ª–∫–∞–Ω–∏" },

    // --- –ê–†–ï–ù–ò –¢–ê –ü–û–•–Ü–î–ù–Ü (Strict) ---
    "Benzene_Pure": { ua: "–ë–µ–Ω–∑–æ–ª", en: "Benzene", class: "–ê—Ä–µ–Ω–∏" },
    "Benzene_Methyl": { ua: "–¢–æ–ª—É–µ–Ω (–ú–µ—Ç–∏–ª–±–µ–Ω–∑–æ–ª)", en: "Toluene", class: "–ê—Ä–µ–Ω–∏" },
    "Benzene_Cl": { ua: "–•–ª–æ—Ä–±–µ–Ω–∑–æ–ª", en: "Chlorobenzene", class: "–ì–∞–ª–æ–≥–µ–Ω–∞—Ä–µ–Ω–∏" },
    "Benzene_CHO": { ua: "–ë–µ–Ω–∑–∞–ª—å–¥–µ–≥—ñ–¥", en: "Benzaldehyde", class: "–ê—Ä–æ–º–∞—Ç–∏—á–Ω—ñ –∞–ª—å–¥–µ–≥—ñ–¥–∏" },
    "Benzene_OH": { ua: "–§–µ–Ω–æ–ª", en: "Phenol", class: "–§–µ–Ω–æ–ª–∏" },
    "Benzene_NH2": { ua: "–ê–Ω—ñ–ª—ñ–Ω", en: "Aniline", class: "–ê—Ä–æ–º–∞—Ç–∏—á–Ω—ñ –∞–º—ñ–Ω–∏" },
    "Benzene_COOH": { ua: "–ë–µ–Ω–∑–æ–π–Ω–∞ –∫–∏—Å–ª–æ—Ç–∞", en: "Benzoic acid", class: "–ö–∞—Ä–±–æ–Ω–æ–≤—ñ –∫–∏—Å–ª–æ—Ç–∏" },

    // --- –ê–õ–ö–ï–ù–ò ---
    "C2_d1": { ua: "–ï—Ç–µ–Ω", en: "Ethene", class: "–ê–ª–∫–µ–Ω–∏" },
    "C3_d1": { ua: "–ü—Ä–æ–ø–µ–Ω", en: "Propene", class: "–ê–ª–∫–µ–Ω–∏" },

    // --- –°–ü–ò–†–¢–ò –¢–ê –ü–û–õ–Ü–û–õ–ò ---
    "C1_OH1": { ua: "–ú–µ—Ç–∞–Ω–æ–ª", en: "Methanol", class: "–°–ø–∏—Ä—Ç–∏" },
    "C2_OH1": { ua: "–ï—Ç–∞–Ω–æ–ª", en: "Ethanol", class: "–°–ø–∏—Ä—Ç–∏" },
    "C3_OH1_pos1": { ua: "–ü—Ä–æ–ø–∞–Ω-1-–æ–ª", en: "Propan-1-ol", class: "–°–ø–∏—Ä—Ç–∏" },
    "C3_OH1_pos2": { ua: "–ü—Ä–æ–ø–∞–Ω-2-–æ–ª", en: "Propan-2-ol", class: "–°–ø–∏—Ä—Ç–∏" },
    "C3_OH3": { ua: "–ì–ª—ñ—Ü–µ—Ä–æ–ª (–ì–ª—ñ—Ü–µ—Ä–∏–Ω)", en: "Glycerol", class: "–ë–∞–≥–∞—Ç–æ–∞—Ç–æ–º–Ω—ñ —Å–ø–∏—Ä—Ç–∏" },

    // --- –ï–¢–ï–†–ò ---
    "Ether_C1_C1": { ua: "–î–∏–º–µ—Ç–∏–ª–æ–≤–∏–π –µ—Ç–µ—Ä", en: "Dimethyl ether", class: "–ï—Ç–µ—Ä–∏" },
    "Ether_C1_C2": { ua: "–ú–µ—Ç–∏–ª–µ—Ç–∏–ª–æ–≤–∏–π –µ—Ç–µ—Ä", en: "Methoxyethane", class: "–ï—Ç–µ—Ä–∏" },
    "Ether_C2_C2": { ua: "–î—ñ–µ—Ç–∏–ª–æ–≤–∏–π –µ—Ç–µ—Ä", en: "Diethyl ether", class: "–ï—Ç–µ—Ä–∏" },

    // --- –ê–õ–¨–î–ï–ì–Ü–î–ò ---
    "C1_CHO": { ua: "–ú–µ—Ç–∞–Ω–∞–ª—å", en: "Methanal", class: "–ê–ª—å–¥–µ–≥—ñ–¥–∏" },
    "C2_CHO": { ua: "–ï—Ç–∞–Ω–∞–ª—å", en: "Ethanal", class: "–ê–ª—å–¥–µ–≥—ñ–¥–∏" },
    "C3_CHO": { ua: "–ü—Ä–æ–ø–∞–Ω–∞–ª—å", en: "Propanal", class: "–ê–ª—å–¥–µ–≥—ñ–¥–∏" },

    // --- –ö–ï–¢–û–ù–ò ---
    "C3_CO": { ua: "–ü—Ä–æ–ø–∞–Ω–æ–Ω (–ê—Ü–µ—Ç–æ–Ω)", en: "Propanone", class: "–ö–µ—Ç–æ–Ω–∏" },
    "C4_CO": { ua: "–ë—É—Ç–∞–Ω–æ–Ω", en: "Butanone", class: "–ö–µ—Ç–æ–Ω–∏" },

    // --- –ö–ò–°–õ–û–¢–ò ---
    "Acid_C2_CHO": { ua: "–ì–ª—ñ–æ–∫—Å–∞–ª–µ–≤–∞ –∫–∏—Å–ª–æ—Ç–∞", en: "Glyoxylic acid", class: "–ê–ª—å–¥–µ–≥—ñ–¥–æ–∫–∏—Å–ª–æ—Ç–∏" },
    "Acid_C3_CO": { ua: "–ü—ñ—Ä–æ–≤–∏–Ω–æ–≥—Ä–∞–¥–Ω–∞ –∫–∏—Å–ª–æ—Ç–∞", en: "Pyruvic acid", class: "–ö–µ—Ç–æ–∫–∏—Å–ª–æ—Ç–∏" },
    "Acid_C1": { ua: "–ú–µ—Ç–∞–Ω–æ–≤–∞ –∫-—Ç–∞", en: "Methanoic acid", class: "–ö–∞—Ä–±–æ–Ω–æ–≤—ñ –∫–∏—Å–ª–æ—Ç–∏" },
    "Acid_C2": { ua: "–ï—Ç–∞–Ω–æ–≤–∞ –∫-—Ç–∞", en: "Ethanoic acid", class: "–ö–∞—Ä–±–æ–Ω–æ–≤—ñ –∫–∏—Å–ª–æ—Ç–∏" },
    "Acid_C3": { ua: "–ü—Ä–æ–ø–∞–Ω–æ–≤–∞ –∫-—Ç–∞", en: "Propanoic acid", class: "–ö–∞—Ä–±–æ–Ω–æ–≤—ñ –∫–∏—Å–ª–æ—Ç–∏" },
    "Acid_C4": { ua: "–ë—É—Ç–∞–Ω–æ–≤–∞ –∫-—Ç–∞", en: "Butanoic acid", class: "–ö–∞—Ä–±–æ–Ω–æ–≤—ñ –∫–∏—Å–ª–æ—Ç–∏" },

    // --- –ê–ú–Ü–ù–ò –¢–ê –ê–ú–Ü–ù–û–ö–ò–°–õ–û–¢–ò ---
    "C1_NH2": { ua: "–ú–µ—Ç–∏–ª–∞–º—ñ–Ω", en: "Methylamine", class: "–ê–º—ñ–Ω–∏" },
    "C2_NH2": { ua: "–ï—Ç–∏–ª–∞–º—ñ–Ω", en: "Ethylamine", class: "–ê–º—ñ–Ω–∏" },
    "AA_Glycine": { ua: "–ì–ª—ñ—Ü–∏–Ω", en: "Glycine", class: "–ê–º—ñ–Ω–æ–∫–∏—Å–ª–æ—Ç–∏" },
    "AA_Alanine": { ua: "–ê–ª–∞–Ω—ñ–Ω", en: "Alanine", class: "–ê–º—ñ–Ω–æ–∫–∏—Å–ª–æ—Ç–∏" },
    "AA_Serine": { ua: "–°–µ—Ä–∏–Ω", en: "Serine", class: "–ê–º—ñ–Ω–æ–∫–∏—Å–ª–æ—Ç–∏" },
    "AA_Phenylalanine": { ua: "–§–µ–Ω—ñ–ª–∞–ª–∞–Ω—ñ–Ω", en: "Phenylalanine", class: "–ê–º—ñ–Ω–æ–∫–∏—Å–ª–æ—Ç–∏" },

    // --- –ì–ê–õ–û–ì–ï–ù–ò ---
    "C1_Cl1": { ua: "–•–ª–æ—Ä–º–µ—Ç–∞–Ω", en: "Chloromethane", class: "–ì–∞–ª–æ–≥–µ–Ω–æ–ø–æ—Ö—ñ–¥–Ω—ñ" },
    "C1_Cl3": { ua: "–•–ª–æ—Ä–æ—Ñ–æ—Ä–º", en: "Chloroform", class: "–ì–∞–ª–æ–≥–µ–Ω–æ–ø–æ—Ö—ñ–¥–Ω—ñ" }
};

class Atom {
    constructor(type, x, y) {
        this.id = Math.random().toString(36).substr(2, 9);
        this.type = type;
        this.x = x; this.y = y;
        this.vx = 0; this.vy = 0;
        this.bonds = [];
        this.radicals = 0;
    }
    get spec() { return ATOM_SPECS[this.type]; }
}

class Bond {
    constructor(a1, a2, type=1) {
        this.id = Math.random().toString(36).substr(2, 9);
        this.a1 = a1; this.a2 = a2;
        this.type = type; // 1, 2, 1.5 (aromatic)
    }
}

class App {
    constructor() {
        this.canvas = document.getElementById('chemCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.atoms = [];
        this.bonds = [];
        this.scale = 1;
        this.offsetX = 0; this.offsetY = 0;
        this.selectedGroup = null;
        this.connectMode = false;
        this.selectedForConnection = [];
        this.isDragging = false;
        this.lastMouse = {x:0, y:0};

        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.initInput();
        this.spawnMolecule('methane');
        this.loop();
    }

    resize() {
        this.canvas.width = this.canvas.parentElement.clientWidth;
        this.canvas.height = this.canvas.parentElement.clientHeight;
        this.cx = this.canvas.width / 2;
        this.cy = this.canvas.height / 2;
    }

    loadPreset() {
        const val = document.getElementById('preset-select').value;
        this.spawnMolecule(val);
    }

    /** –ì–ï–ù–ï–†–ê–¶–Ü–Ø –ú–û–õ–ï–ö–£–õ **/
    spawnMolecule(type) {
        this.clear(); // –û—á–∏—â–∞—î–º–æ –ø–µ—Ä–µ–¥ —Å–ø–∞–≤–Ω–æ–º
        const px = 0; const py = 0;
        
        // Helper: Create Chain
        const createChain = (n, startX, startY) => {
            let ids = [];
            for(let i=0; i<n; i++) ids.push(this.addAtom('C', startX + i*60, startY));
            for(let i=0; i<n-1; i++) this.addBond(ids[i], ids[i+1]);
            return ids;
        };

        if (['methane','ethane','propane','butane','pentane'].includes(type) || type.startsWith('C')) {
            const map = {methane:1, ethane:2, propane:3};
            const n = map[type] || (type==='methane'?1:3); 
            const chain = createChain(n, px-((n-1)*30), py);
            chain.forEach(id => this.saturate(id));
        }
        else if (type === 'benzene' || type === 'phenol' || type === 'toluene' || type === 'aniline' || type === 'benzoic_acid') {
            const ids = [];
            for(let i=0; i<6; i++) {
                let ang = i*60*Math.PI/180; ids.push(this.addAtom('C', px+Math.cos(ang)*75, py+Math.sin(ang)*75));
            }
            for(let i=0; i<6; i++) {
                this.addBond(ids[i], ids[(i+1)%6], 1.5);
                if(i===0) {
                    if(type==='phenol') { const o=this.addAtom('O', px+140, py); this.addBond(ids[i], o); this.saturate(o); }
                    else if(type==='toluene') { const c=this.addAtom('C', px+140, py); this.addBond(ids[i], c); this.saturate(c); }
                    else if(type==='aniline') { const n=this.addAtom('N', px+140, py); this.addBond(ids[i], n); this.saturate(n); }
                    else if(type==='benzoic_acid') {
                         const c=this.addAtom('C', px+140, py); this.addBond(ids[i], c);
                         const o1=this.addAtom('O', px+160, py-30); this.addBond(c, o1, 2);
                         const o2=this.addAtom('O', px+160, py+30); this.addBond(c, o2); this.saturate(o2);
                    }
                    else { const h=this.addAtom('H', this.getAtom(ids[i]).x*1.4, this.getAtom(ids[i]).y*1.4); this.addBond(ids[i], h); }
                } else {
                    const h=this.addAtom('H', this.getAtom(ids[i]).x*1.4, this.getAtom(ids[i]).y*1.4); this.addBond(ids[i], h);
                }
            }
        }
        else if (type === 'ethanol') {
            const c1=this.addAtom('C', -30, 0); const c2=this.addAtom('C', 30, 0); this.addBond(c1,c2);
            const o=this.addAtom('O', 80, 0); this.addBond(c2,o); this.saturate(c1); this.saturate(c2); this.saturate(o);
        }
        else if (type === 'glycerol') {
            const c = createChain(3, -50, 0);
            c.forEach((id, i) => {
                const o = this.addAtom('O', this.getAtom(id).x, this.getAtom(id).y+50);
                this.addBond(id, o); this.saturate(o); this.saturate(id);
            });
        }
        else if (type === 'acetic_acid') {
            const c1=this.addAtom('C', -30, 0); const c2=this.addAtom('C', 30, 0); this.addBond(c1,c2);
            const o1=this.addAtom('O', 60, -30); this.addBond(c2,o1,2);
            const o2=this.addAtom('O', 60, 30); this.addBond(c2,o2); this.saturate(o2); this.saturate(c1);
        }
        else if (type === 'pyruvic_acid') {
            const c1=this.addAtom('C', -60, 0); const c2=this.addAtom('C', 0, 0); const c3=this.addAtom('C', 60, 0);
            this.addBond(c1,c2); this.addBond(c2,c3);
            const ok=this.addAtom('O', 0, -50); this.addBond(c2, ok, 2);
            const oa=this.addAtom('O', 90, -30); this.addBond(c3, oa, 2);
            const ob=this.addAtom('O', 90, 30); this.addBond(c3, ob); this.saturate(ob);
            this.saturate(c1);
        }
        else if (type === 'alanine') {
            const c1=this.addAtom('C', -30, 0); const c2=this.addAtom('C', 30, 0); const c3=this.addAtom('C', 90, 0);
            this.addBond(c1,c2); this.addBond(c2,c3);
            const n=this.addAtom('N', 30, -50); this.addBond(c2,n); this.saturate(n);
            const o1=this.addAtom('O', 120, -30); this.addBond(c3,o1,2);
            const o2=this.addAtom('O', 120, 30); this.addBond(c3,o2); this.saturate(o2);
            this.saturate(c1); this.saturate(c2);
        }
        // --- –¶–ò–ö–õ–Ü–ß–ù–Ü –¶–£–ö–†–ò (–ù–û–í–ï) ---
        else if (type === 'glucose') { // Glucopyranose
            const ids = [];
            // O is index 0. C1..C5 are 1..5. Hexagon layout.
            const coords = [[50,-40], [100,0], [100,60], [50,100], [0,60], [0,0]]; // relative offsets
            const o = this.addAtom('O', px+coords[0][0], py+coords[0][1]);
            const c1 = this.addAtom('C', px+coords[1][0], py+coords[1][1]);
            const c2 = this.addAtom('C', px+coords[2][0], py+coords[2][1]);
            const c3 = this.addAtom('C', px+coords[3][0], py+coords[3][1]);
            const c4 = this.addAtom('C', px+coords[4][0], py+coords[4][1]);
            const c5 = this.addAtom('C', px+coords[5][0], py+coords[5][1]);

            this.addBond(o, c1); this.addBond(c1, c2); this.addBond(c2, c3);
            this.addBond(c3, c4); this.addBond(c4, c5); this.addBond(c5, o);

            // C6 attached to C5
            const c6 = this.addAtom('C', px-50, py-30); this.addBond(c5, c6);
            const o6 = this.addAtom('O', px-80, py-60); this.addBond(c6, o6); this.saturate(o6);
            
            // OH Groups
            const addOH = (cId, dx, dy) => { const a=this.getAtom(cId); const o=this.addAtom('O', a.x+dx, a.y+dy); this.addBond(cId, o); this.saturate(o); };
            addOH(c1, 40, 0); addOH(c2, 40, 20); addOH(c3, 0, 40); addOH(c4, -40, 0);

            [c1,c2,c3,c4,c5,c6].forEach(id => this.saturate(id));
        }
        else if (type === 'fructose') { // Fructofuranose
            // O top, C2 right, C3 bottom right, C4 bottom left, C5 left.
            const o = this.addAtom('O', px, py-50);
            const c2 = this.addAtom('C', px+50, py-20);
            const c3 = this.addAtom('C', px+30, py+40);
            const c4 = this.addAtom('C', px-30, py+40);
            const c5 = this.addAtom('C', px-50, py-20);

            this.addBond(o, c2); this.addBond(c2, c3); this.addBond(c3, c4); this.addBond(c4, c5); this.addBond(c5, o);

            // Substituents
            // C1 on C2
            const c1 = this.addAtom('C', px+90, py-40); this.addBond(c2, c1); 
            const o1 = this.addAtom('O', px+120, py-20); this.addBond(c1, o1); this.saturate(o1);

            // C6 on C5
            const c6 = this.addAtom('C', px-90, py-40); this.addBond(c5, c6);
            const o6 = this.addAtom('O', px-120, py-20); this.addBond(c6, o6); this.saturate(o6);

            // OH on C3, C4
            const addOH = (cId, dx, dy) => { const a=this.getAtom(cId); const oh=this.addAtom('O', a.x+dx, a.y+dy); this.addBond(cId, oh); this.saturate(oh); };
            addOH(c3, 0, 40); addOH(c4, 0, 40);
            // OH on C2 (Hemiketal)
            addOH(c2, 20, 30);

            [c1,c2,c3,c4,c5,c6].forEach(id => this.saturate(id));
        }
        else if (type === 'ribose') { // Ribofuranose
            const o = this.addAtom('O', px, py-50);
            const c1 = this.addAtom('C', px+50, py-20);
            const c2 = this.addAtom('C', px+30, py+40);
            const c3 = this.addAtom('C', px-30, py+40);
            const c4 = this.addAtom('C', px-50, py-20);

            this.addBond(o, c1); this.addBond(c1, c2); this.addBond(c2, c3); this.addBond(c3, c4); this.addBond(c4, o);

            // C5 on C4
            const c5 = this.addAtom('C', px-90, py-40); this.addBond(c4, c5);
            const o5 = this.addAtom('O', px-120, py-20); this.addBond(c5, o5); this.saturate(o5);

            const addOH = (cId, dx, dy) => { const a=this.getAtom(cId); const oh=this.addAtom('O', a.x+dx, a.y+dy); this.addBond(cId, oh); this.saturate(oh); };
            addOH(c1, 40, 0); addOH(c2, 20, 30); addOH(c3, -20, 30);

            [c1,c2,c3,c4,c5].forEach(id => this.saturate(id));
        }

        this.analyze();
    }

    addAtom(type, x, y) {
        const a = new Atom(type, x, y); this.atoms.push(a); return a.id;
    }

    addBond(id1, id2, type=1) {
        if(id1 === id2 || this.getBond(id1, id2)) return;
        this.bonds.push(new Bond(id1, id2, type));
        this.getAtom(id1).bonds.push(id2); this.getAtom(id2).bonds.push(id1);
    }

    removeAtom(id) {
        const atom = this.getAtom(id); if(!atom) return;
        const connectedBonds = this.bonds.filter(b => b.a1 === id || b.a2 === id);
        connectedBonds.forEach(b => {
            const neighborId = b.a1 === id ? b.a2 : b.a1;
            const neighbor = this.getAtom(neighborId);
            neighbor.bonds = neighbor.bonds.filter(bid => bid !== id);
            if(atom.type === 'H') neighbor.radicals += b.type;
            else {
                if(neighbor.type === 'C') { const hId = this.addAtom('H', atom.x, atom.y); this.addBond(neighborId, hId); }
                else neighbor.radicals += b.type;
            }
        });
        this.atoms = this.atoms.filter(a => a.id !== id);
        this.bonds = this.bonds.filter(b => b.a1 !== id && b.a2 !== id);
        this.analyze();
    }

    saturate(atomOrId) {
        const atom = typeof atomOrId==='string' ? this.getAtom(atomOrId) : atomOrId;
        const currentValence = atom.bonds.reduce((acc, bid) => acc + this.getBond(atom.id, bid).type, 0);
        const needed = atom.spec.valence - currentValence;
        for(let i=0; i<needed; i++) {
            const ang = Math.random()*6.28;
            const h = this.addAtom('H', atom.x+Math.cos(ang)*BOND_LEN, atom.y+Math.sin(ang)*BOND_LEN);
            this.addBond(atom.id, h);
        }
    }

    spawnFragment(group, x, y) {
        if(group === 'CH3') { const c = this.addAtom('C', x, y); this.saturate(c); this.removeAtom(this.getAtom(c).bonds[0]); }
        else if(group === 'NH2') { const n = this.addAtom('N', x, y); this.saturate(n); this.removeAtom(this.getAtom(n).bonds[0]); }
        else if(group === 'OH') { const o = this.addAtom('O', x, y); this.saturate(o); this.removeAtom(this.getAtom(o).bonds[0]); }
        else if(group === 'COOH') {
             const c = this.addAtom('C', x, y);
             const o1 = this.addAtom('O', x+20, y-25); this.addBond(c, o1, 2);
             const o2 = this.addAtom('O', x+20, y+25); this.addBond(c, o2);
             const h = this.addAtom('H', x+40, y+25); this.addBond(o2, h);
             this.getAtom(c).radicals = 1; 
        } else if(group === 'CO') { 
             const c = this.addAtom('C', x, y);
             const o = this.addAtom('O', x, y-35); this.addBond(c, o, 2);
             this.getAtom(c).radicals = 2; 
        } else if(group === 'CHO') { 
             const c = this.addAtom('C', x, y);
             const o = this.addAtom('O', x+20, y-25); this.addBond(c, o, 2);
             const h = this.addAtom('H', x+20, y+25); this.addBond(c, h);
             this.getAtom(c).radicals = 1;
        } else if(group === 'O_ether') { const o = this.addAtom('O', x, y); this.getAtom(o).radicals = 2; }
        else if(group === 'Cl') { const cl = this.addAtom('Cl', x, y); this.getAtom(cl).radicals = 1; }
        this.showMessage("–°—Ç–≤–æ—Ä–µ–Ω–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç"); this.analyze();
    }

    attachGroupToAtom(target) {
        const type = this.selectedGroup; target.radicals--;
        const bx = target.x+40; const by = target.y+40;
        if (type==='OH') { const o=this.addAtom('O',bx,by); this.addBond(target.id,o); this.saturate(o); }
        else if (type==='NH2') { const n=this.addAtom('N',bx,by); this.addBond(target.id,n); this.saturate(n); }
        else if (type==='COOH') { 
            const c=this.addAtom('C',bx,by); this.addBond(target.id,c);
            this.addBond(c, this.addAtom('O',bx+10,by-20), 2);
            const o2=this.addAtom('O',bx+10,by+20); this.addBond(c,o2); this.addBond(o2, this.addAtom('H',bx+30,by+25));
        }
        else if (type==='Cl') { this.addBond(target.id, this.addAtom('Cl',bx,by)); }
        else if (type==='CH3') { const c=this.addAtom('C',bx,by); this.addBond(target.id,c); this.saturate(c); }
        else if (type==='CHO') {
            const c=this.addAtom('C',bx,by); this.addBond(target.id,c);
            this.addBond(c, this.addAtom('O',bx+10,by-20), 2); this.addBond(c, this.addAtom('H',bx+10,by+20));
        }
        else if (type==='CO') { const c=this.addAtom('C',bx,by); this.addBond(target.id,c); this.addBond(c, this.addAtom('O',bx,by-25), 2); this.getAtom(c).radicals = 1; } 
        else if (type==='O_ether') { const o=this.addAtom('O',bx,by); this.addBond(target.id,o); this.getAtom(o).radicals = 1; }
        this.analyze();
    }

    selectGroup(group, el) {
        this.selectedGroup = group;
        document.querySelectorAll('.component-btn').forEach(b => b.classList.remove('active'));
        if(el) el.classList.add('active');
        this.connectMode = false; this.selectedForConnection = [];
        this.showMessage(`–û–±—Ä–∞–Ω–æ: ${group}. –ö–ª—ñ–∫–Ω—ñ—Ç—å —á–µ—Ä–≤–æ–Ω–∏–π –∑–≤'—è–∑–æ–∫.`);
        document.getElementById('btn-connect').classList.remove('active');
    }

    toggleConnectMode() {
        this.connectMode = !this.connectMode;
        this.selectedGroup = null; this.selectedForConnection = [];
        document.querySelectorAll('.component-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById('btn-connect');
        btn.classList.toggle('active', this.connectMode);
        this.showMessage(this.connectMode ? "–û–±–µ—Ä—ñ—Ç—å –¥–≤–∞ —Ä–∞–¥–∏–∫–∞–ª–∏ –¥–ª—è –∑'—î–¥–Ω–∞–Ω–Ω—è." : "–†–µ–∂–∏–º –∑'—î–¥–Ω–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ.");
    }

    handleCanvasClick(x, y) {
        const atom = this.atoms.find(a => Math.hypot(a.x-x, a.y-y) < a.spec.radius+10);
        if (atom) {
            if (this.connectMode) {
                if (atom.radicals > 0) {
                    if(this.selectedForConnection.includes(atom.id)) this.selectedForConnection = [];
                    else {
                        this.selectedForConnection.push(atom.id);
                        if(this.selectedForConnection.length === 2) this.performConnection();
                    }
                } else this.showMessage("–¶–µ–π –∞—Ç–æ–º –Ω–µ –º–∞—î –≤—ñ–ª—å–Ω–∏—Ö –∑–≤'—è–∑–∫—ñ–≤!");
                return;
            }
            if (atom.type === 'H') this.removeAtom(atom.id); 
            else if (!this.selectedGroup && (atom.type !== 'C' || (atom.type==='C' && atom.bonds.length===1))) {
                 if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü—é –≥—Ä—É–ø—É/–∞—Ç–æ–º?")) this.removeAtom(atom.id);
            }
            else if (this.selectedGroup && atom.radicals > 0) this.attachGroupToAtom(atom);
        } else if (this.selectedGroup) this.spawnFragment(this.selectedGroup, x, y);
    }

    performConnection() {
        const a1 = this.getAtom(this.selectedForConnection[0]);
        const a2 = this.getAtom(this.selectedForConnection[1]);
        const bond = this.getBond(a1.id, a2.id);
        if (bond) { bond.type += 1; a1.radicals--; a2.radicals--; this.showMessage("–°—Ç–≤–æ—Ä–µ–Ω–æ –∫—Ä–∞—Ç–Ω–∏–π –∑–≤'—è–∑–æ–∫!"); } 
        else { this.addBond(a1.id, a2.id); a1.radicals--; a2.radicals--; this.showMessage("–§—Ä–∞–≥–º–µ–Ω—Ç–∏ –∑'—î–¥–Ω–∞–Ω–æ!"); }
        this.selectedForConnection = []; this.connectMode = false;
        document.getElementById('btn-connect').classList.remove('active');
        this.analyze();
    }

    /** –ê–ù–ê–õ–Ü–ó (–í–ò–î–ê–õ–ï–ù–û –†–û–ó–ü–Ü–ó–ù–ê–í–ê–ù–ù–Ø –¶–£–ö–†–Ü–í) **/
    analyze() {
        const counts = { C:0, H:0, O:0, N:0, Cl:0 };
        this.atoms.forEach(a => counts[a.type] = (counts[a.type]||0) + 1);

        let formula = '';
        ['C','H','N','O','Cl'].forEach(el => { if(counts[el]) formula += el + (counts[el]>1?counts[el]:''); });
        document.getElementById('info-formula').innerText = formula || '-';

        const f = { COOH:0, CHO:0, OH:0, NH2:0, CO:0, Ether:0, Dbl:0, Arom:0, Cl:counts.Cl };
        
        this.atoms.forEach(a => {
            if(a.type === 'C') {
                const oxs = a.bonds.map(id=>this.getAtom(id)).filter(n => n.type==='O');
                const dblO = oxs.find(o => this.getBond(a.id, o.id).type === 2);
                const sglO = oxs.find(o => this.getBond(a.id, o.id).type === 1);
                
                if(dblO && sglO && sglO.bonds.some(id => this.getAtom(id).type === 'H')) f.COOH++;
                else if(dblO && a.bonds.some(id => this.getAtom(id).type === 'H') && !sglO) f.CHO++;
                else if(dblO && !sglO) {
                     const cNeighbors = a.bonds.filter(id => this.getAtom(id).type === 'C').length;
                     if(cNeighbors >= 2) f.CO++;
                }
            } else if (a.type === 'O') {
                 const neighbors = a.bonds.map(id => this.getAtom(id));
                 const cN = neighbors.filter(n => n.type === 'C').length;
                 const hN = neighbors.filter(n => n.type === 'H').length;
                 const isCOOH = neighbors.some(n => n.type === 'C' && n.bonds.some(nid => {
                         const nn = this.getAtom(nid); return nn.type === 'O' && this.getBond(n.id, nid).type === 2;
                 }));
                 if(!isCOOH) {
                     if(cN === 1 && hN === 1) f.OH++;
                     if(cN === 2) f.Ether++;
                 }
            } else if (a.type === 'N' && a.bonds.filter(id => this.getAtom(id).type === 'H').length === 2) f.NH2++;
        });

        this.bonds.forEach(b => {
            if(b.type === 2 && this.getAtom(b.a1).type==='C' && this.getAtom(b.a2).type==='C') f.Dbl++;
            if(b.type === 1.5) f.Arom = 1;
        });

        let key = null;

        // --- –°–¢–ê–ù–î–ê–†–¢–ù–ê –õ–û–ì–Ü–ö–ê ---
        if (f.Arom) {
            if (f.COOH && f.NH2 && counts.C >= 9) key = "AA_Phenylalanine";
            else if (f.COOH) key = "Benzene_COOH";
            else if (f.CHO) key = "Benzene_CHO";
            else if (f.OH) key = "Benzene_OH";
            else if (f.NH2) key = "Benzene_NH2";
            else if (f.Cl) key = "Benzene_Cl";
            else if (counts.C === 7 && counts.O === 0 && counts.N === 0) key = "Benzene_Methyl";
            else if (counts.C === 6 && counts.O === 0 && counts.N === 0) key = "Benzene_Pure";
        }
        else if(f.COOH && f.NH2) {
            if(f.OH) key = "AA_Serine"; else if(counts.C === 2) key = "AA_Glycine"; else if(counts.C === 3) key = "AA_Alanine";
        }
        else if (f.COOH && f.CO) key = `Acid_C${counts.C}_CO`;
        else if (f.COOH && f.CHO) key = `Acid_C${counts.C}_CHO`;
        else if(f.COOH) key = `Acid_C${counts.C}`;
        else if(f.Ether) {
            const etherO = this.atoms.find(a => a.type === 'O' && a.bonds.filter(bid => this.getAtom(bid).type === 'C').length === 2);
            if(etherO) {
                const branches = etherO.bonds.map(startCId => {
                    const visited = new Set([etherO.id]); const queue = [startCId]; let cCount = 0;
                    while(queue.length){ const curr=queue.shift(); if(visited.has(curr))continue; visited.add(curr);
                    if(this.getAtom(curr).type==='C')cCount++;
                    this.getAtom(curr).bonds.forEach(b=>{if(!visited.has(b))queue.push(b)}); } return cCount;
                });
                branches.sort((a,b)=>a-b); key = `Ether_C${branches[0]}_C${branches[1]}`;
            }
        }
        else if(f.CHO) key = `C${counts.C}_CHO`;
        else if(f.CO) key = `C${counts.C}_CO`;
        else if(f.OH) {
            if(counts.C === 3 && f.OH === 3) key = "C3_OH3"; // –ì–ª—ñ—Ü–µ—Ä–æ–ª
            else {
                key = `C${counts.C}_OH${f.OH}`;
                if(counts.C===3 && f.OH===1) {
                    const cOH = this.atoms.find(a=>a.type==='C'&&a.bonds.some(id=>this.getAtom(id).type==='O'));
                    key += (cOH.bonds.filter(id=>this.getAtom(id).type==='C').length===2)?"_pos2":"_pos1";
                }
            }
        }
        else if(f.NH2) key = `C${counts.C}_NH2`;
        else if(f.Cl) key = `C${counts.C}_Cl${f.Cl}`;
        else if(f.Dbl) key = `C${counts.C}_d${f.Dbl}`;
        else if (counts.O === 0 && counts.N === 0 && counts.Cl === 0) {
             key = `C${counts.C}`;
             if(counts.C === 4 || counts.C === 5) {
                 const maxD = Math.max(...this.atoms.filter(a=>a.type==='C').map(c=>c.bonds.filter(id=>this.getAtom(id).type==='C').length));
                 key += (maxD > 2) ? "_branched" : "_linear";
             }
        }

        const data = KNOWLEDGE_BASE[key];
        
        if(data) {
            document.getElementById('info-name').innerText = data.ua;
            document.getElementById('info-name-en').innerText = data.en;
            document.getElementById('info-class').innerText = data.class;
        } else {
            let detectedClass = "–ù–µ–≤—ñ–¥–æ–º–∞ –æ—Ä–≥–∞–Ω—ñ—á–Ω–∞ —Å–ø–æ–ª—É–∫–∞";
            if(f.COOH && f.NH2) detectedClass = "–ê–º—ñ–Ω–æ–∫–∏—Å–ª–æ—Ç–∞ (—ñ–Ω—à–∞)";
            else if(f.COOH && f.CO) detectedClass = "–ö–µ—Ç–æ–∫–∏—Å–ª–æ—Ç–∞";
            else if(f.COOH) detectedClass = "–ö–∞—Ä–±–æ–Ω–æ–≤–∞ –∫–∏—Å–ª–æ—Ç–∞";
            else if(f.Ether && f.OH) detectedClass = "–¶–∏–∫–ª—ñ—á–Ω–∏–π –µ—Ç–µ—Ä / –ù–∞–ø—ñ–≤–∞—Ü–µ—Ç–∞–ª—å"; // –¶—É–∫—Ä–∏ —Å—é–¥–∏ –ø–æ—Ç—Ä–∞–ø–ª—è—Ç—å
            else if(f.Ether) detectedClass = "–ï—Ç–µ—Ä";
            else if(f.CHO) detectedClass = "–ê–ª—å–¥–µ–≥—ñ–¥";
            else if(f.CO) detectedClass = "–ö–µ—Ç–æ–Ω";
            else if(f.OH > 1) detectedClass = "–ë–∞–≥–∞—Ç–æ–∞—Ç–æ–º–Ω–∏–π —Å–ø–∏—Ä—Ç";
            else if(f.OH) detectedClass = (f.Arom ? "–§–µ–Ω–æ–ª (–ø–æ—Ö—ñ–¥–Ω–∞)" : "–°–ø–∏—Ä—Ç");
            else if(f.NH2) detectedClass = "–ê–º—ñ–Ω";
            else if(f.Arom) detectedClass = "–ê—Ä–æ–º–∞—Ç–∏—á–Ω–∞ —Å–ø–æ–ª—É–∫–∞";
            else if(f.Dbl) detectedClass = "–ê–ª–∫–µ–Ω";
            else if(f.Cl) detectedClass = "–ì–∞–ª–æ–≥–µ–Ω–æ–ø–æ—Ö—ñ–¥–Ω–∞";
            else if(counts.C > 0 && !counts.O && !counts.N) detectedClass = "–ê–ª–∫–∞–Ω (—ñ–∑–æ–º–µ—Ä)";

            document.getElementById('info-name').innerText = formula; 
            document.getElementById('info-name-en').innerText = "Unknown Structure";
            document.getElementById('info-class').innerText = detectedClass;
        }
    }

    getAtom(id) { return this.atoms.find(a => a.id === id); }
    getBond(a1, a2) { return this.bonds.find(b => (b.a1==a1 && b.a2==a2) || (b.a1==a2 && b.a2==a1)); }
    showMessage(msg) { const b=document.getElementById('message-box'); b.innerText=msg; b.style.opacity=1; clearTimeout(this.t); this.t=setTimeout(()=>b.style.opacity=0,3000); }
    clear() { this.atoms=[]; this.bonds=[]; this.analyze(); this.connectMode=false; document.getElementById('btn-connect').classList.remove('active'); }
    resetView() { this.scale=1; this.offsetX=0; this.offsetY=0; }

    /** DRAG & DROP + INPUT **/
    initInput() {
        this.draggedAtom = null;
        this.isCameraPan = false;
        this.clickStartX = 0;
        this.clickStartY = 0;

        this.canvas.addEventListener('mousedown', e => {
            const mouseWorld = this.toWorld(e.offsetX, e.offsetY);
            const clickedAtom = this.atoms.find(a => Math.hypot(a.x - mouseWorld.x, a.y - mouseWorld.y) < a.spec.radius + 10);
            this.clickStartX = e.offsetX; this.clickStartY = e.offsetY;

            if (clickedAtom) {
                this.draggedAtom = clickedAtom;
                clickedAtom.vx = 0; clickedAtom.vy = 0;
            } else {
                this.isCameraPan = true;
            }
            this.lastMouse = { x: e.offsetX, y: e.offsetY };
        });

        window.addEventListener('mousemove', e => {
            const dx = e.offsetX - this.lastMouse.x;
            const dy = e.offsetY - this.lastMouse.y;
            if (this.draggedAtom) {
                const mouseWorld = this.toWorld(e.offsetX, e.offsetY);
                this.draggedAtom.x = mouseWorld.x; this.draggedAtom.y = mouseWorld.y;
                this.draggedAtom.vx = 0; this.draggedAtom.vy = 0;
            } else if (this.isCameraPan) {
                this.offsetX += dx; this.offsetY += dy;
            }
            this.lastMouse = { x: e.offsetX, y: e.offsetY };
            if(this.draggedAtom) this.canvas.style.cursor = 'grabbing';
            else if(this.isCameraPan) this.canvas.style.cursor = 'move';
            else this.canvas.style.cursor = 'default';
        });

        window.addEventListener('mouseup', e => {
            const dist = Math.hypot(e.offsetX - this.clickStartX, e.offsetY - this.clickStartY);
            if (dist < 5) {
                const worldPos = this.toWorld(e.offsetX, e.offsetY);
                this.handleCanvasClick(worldPos.x, worldPos.y);
            }
            this.draggedAtom = null; this.isCameraPan = false;
            this.canvas.style.cursor = 'default';
        });

        this.canvas.addEventListener('wheel', e => { e.preventDefault(); this.scale *= Math.exp(e.deltaY * -0.001); });
    }
    toWorld(sx, sy) { return { x:(sx-this.cx-this.offsetX)/this.scale, y:(sy-this.cy-this.offsetY)/this.scale }; }

    /** PHYSICS & RENDER LOOP **/
    loop() {
        for(let i=0; i<this.atoms.length; i++){
            for(let j=i+1; j<this.atoms.length; j++){
                const a=this.atoms[i], b=this.atoms[j]; const dx=a.x-b.x, dy=a.y-b.y, d2=dx*dx+dy*dy+1, f=2500/d2, fx=(dx/Math.sqrt(d2))*f, fy=(dy/Math.sqrt(d2))*f;
                a.vx+=fx; a.vy+=fy; b.vx-=fx; b.vy-=fy;
            }
            this.atoms[i].vx -= this.atoms[i].x * 0.003;
            this.atoms[i].vy -= this.atoms[i].y * 0.003;
        }
        this.bonds.forEach(b => {
            const a1=this.getAtom(b.a1), a2=this.getAtom(b.a2); const dx=a2.x-a1.x, dy=a2.y-a1.y, dist=Math.sqrt(dx*dx+dy*dy);
            const target=(b.type===2)?BOND_LEN*0.88:(b.type===1.5?BOND_LEN*0.95:BOND_LEN);
            const f=(dist-target)*0.08, fx=(dx/dist)*f, fy=(dy/dist)*f;
            a1.vx+=fx; a1.vy+=fy; a2.vx-=fx; a2.vy-=fy;
        });
        this.atoms.forEach(a => { if(a!==this.draggedAtom){ a.vx*=0.55; a.vy*=0.55; a.x+=a.vx; a.y+=a.vy; } });

        this.ctx.clearRect(0,0,this.canvas.width, this.canvas.height);
        this.ctx.save(); this.ctx.translate(this.cx+this.offsetX, this.cy+this.offsetY); this.ctx.scale(this.scale, this.scale);
        this.bonds.forEach(b => this.drawBond(b));
        this.atoms.forEach(a => this.drawAtom(a));
        this.ctx.restore(); requestAnimationFrame(()=>this.loop());
    }

    drawAtom(a) {
        const spec = a.spec;
        if(this.selectedForConnection.includes(a.id)) {
            this.ctx.beginPath(); this.ctx.arc(a.x, a.y, spec.radius+5, 0, 6.28);
            this.ctx.fillStyle='rgba(255,235,59,0.6)'; this.ctx.fill();
        }
        const grad = this.ctx.createRadialGradient(a.x-spec.radius/3, a.y-spec.radius/3, spec.radius/10, a.x, a.y, spec.radius);
        grad.addColorStop(0, '#fff'); grad.addColorStop(0.3, spec.color); grad.addColorStop(1, '#222');
        this.ctx.beginPath(); this.ctx.arc(a.x, a.y, spec.radius, 0, 6.28);
        this.ctx.fillStyle = grad; this.ctx.fill();
        this.ctx.fillStyle = spec.fontColor; this.ctx.font=`bold ${spec.radius}px Arial`;
        this.ctx.textAlign='center'; this.ctx.textBaseline='middle';
        this.ctx.fillText(spec.symbol, a.x, a.y+2);
        if(a.radicals > 0) {
             for(let r=0; r<a.radicals; r++) {
                 const baseAngle = (parseInt(a.id, 36) % 100); const ang = baseAngle + r * (Math.PI/2);
                 const rx=a.x+Math.cos(ang)*24, ry=a.y+Math.sin(ang)*24;
                 this.ctx.strokeStyle='#ff4d4d'; this.ctx.lineWidth=4;
                 this.ctx.beginPath(); this.ctx.moveTo(a.x, a.y); this.ctx.lineTo(rx, ry); this.ctx.stroke();
                 this.ctx.beginPath(); this.ctx.arc(rx, ry, 4, 0, 6.28); this.ctx.fillStyle='#ff4d4d'; this.ctx.fill();
             }
        }
    }

    drawBond(b) {
        const a1=this.getAtom(b.a1), a2=this.getAtom(b.a2);
        this.ctx.strokeStyle='#888'; this.ctx.lineWidth=BOND_WIDTH; this.ctx.lineCap='round';
        if(b.type===1) { this.ctx.beginPath(); this.ctx.moveTo(a1.x,a1.y); this.ctx.lineTo(a2.x,a2.y); this.ctx.stroke(); }
        else if(b.type===2) {
            const ang=Math.atan2(a2.y-a1.y, a2.x-a1.x), nx=Math.cos(ang+1.57)*4, ny=Math.sin(ang+1.57)*4;
            this.ctx.beginPath(); this.ctx.moveTo(a1.x+nx,a1.y+ny); this.ctx.lineTo(a2.x+nx,a2.y+ny); this.ctx.stroke();
            this.ctx.beginPath(); this.ctx.moveTo(a1.x-nx,a1.y-ny); this.ctx.lineTo(a2.x-nx,a2.y-ny); this.ctx.stroke();
        } else if(b.type===1.5) {
             this.ctx.beginPath(); this.ctx.moveTo(a1.x,a1.y); this.ctx.lineTo(a2.x,a2.y); this.ctx.stroke();
             this.ctx.save(); this.ctx.strokeStyle='#aaa'; this.ctx.lineWidth=3; this.ctx.setLineDash([6,4]);
             const ang=Math.atan2(a2.y-a1.y, a2.x-a1.x), nx=Math.cos(ang+1.57)*5, ny=Math.sin(ang+1.57)*5;
             this.ctx.beginPath(); this.ctx.moveTo(a1.x+nx,a1.y+ny); this.ctx.lineTo(a2.x+nx,a2.y+ny); this.ctx.stroke();
             this.ctx.restore();
        }
    }
}
const app = new App();
</script>
</body>
</html>